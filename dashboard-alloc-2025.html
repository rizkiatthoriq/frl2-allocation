<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard FRL Analysis</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Light Mode */
            --sidebar-bg: #064e3b;
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --primary-green: #10b981;
            --dark-green: #047857;
            --danger-red: #ef4444;
            --hover-bg: #f8fafc;
            --table-head-bg: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --sidebar-bg: #022c22;
            --main-bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --primary-green: #34d399;
            --dark-green: #6ee7b7;
            --danger-red: #f87171;
            --hover-bg: #334155;
            --table-head-bg: #0f172a;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-main);
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- PERBAIKAN SIDEBAR --- */
        .sidebar {
            width: 260px; 
            background-color: var(--sidebar-bg); 
            padding: 25px;
            display: flex; 
            flex-direction: column; 
            color: white; 
            flex-shrink: 0;
            
            /* Transisi Lebar agar mulus */
            transition: width 0.3s ease, padding 0.3s ease;
            overflow: hidden; /* Sembunyikan konten saat menyusut */
            white-space: nowrap; /* Mencegah teks sidebar turun ke bawah */
        }

        /* Class saat ditutup: Lebar jadi 0, Padding jadi 0 */
        .sidebar.closed { 
            width: 0; 
            padding-left: 0;
            padding-right: 0;
            opacity: 0; /* Opsional: memudarkan konten */
        }

        .logo { font-size: 20px; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--primary-green); font-size: 24px; }
        
        .nav-item {
            padding: 12px 15px; margin-bottom: 6px; border-radius: 12px; cursor: pointer; transition: 0.2s;
            color: rgba(255,255,255,0.7); font-size: 13px; display: flex; align-items: center; gap: 12px;
        }
        .nav-item i { width: 20px; text-align: center; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; font-weight: 500; }
        .nav-item.active { background: var(--primary-green); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }

        /* --- CONTENT AREA --- */
        .main-content { 
            flex-grow: 1; 
            padding: 25px 40px; /* Padding diperbesar agar tidak mentok */
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 25px;
            width: 100%; /* Pastikan mengisi ruang sisa */
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        .icon-btn {
            width: 40px; height: 40px; border-radius: 10px; background: var(--card-bg);
            color: var(--text-muted); display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
        }
        .icon-btn:hover { color: var(--primary-green); border-color: var(--primary-green); }

        .toggle-btn {
            font-size: 18px; color: var(--text-main); cursor: pointer; 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 10px; transition: 0.2s; background: var(--card-bg);
            box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
        }
        .toggle-btn:hover { color: var(--primary-green); }

        .btn-download {
            background: var(--primary-green); color: #fff; border: none; padding: 0 20px; height: 40px;
            border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        .btn-download:hover { opacity: 0.9; transform: translateY(-1px); }

        /* GRID & CARDS */
        .grid-container { display: grid; grid-template-columns: 2.6fr 1fr; gap: 25px; }
        /* Responsif saat Sidebar Hilang: Kolom Grafik Melebar */
        body.sidebar-hidden .grid-container { grid-template-columns: 3fr 1fr; }

        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 25px;
            box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
        }
        .card-title {
            font-size: 15px; font-weight: 600; margin-bottom: 15px; color: var(--dark-green);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* CONTROLS */
        .control-panel { background: var(--card-bg); border-radius: var(--radius); padding: 20px; height: fit-content; position: sticky; top: 0; border: 1px solid var(--border-color); }
        
        .switch-box {
            background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 12px; border-radius: 12px;
            margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }
        
        /* SWITCH CSS */
        .switch-container {
            display: flex; align-items: center; gap: 12px; font-size: 12px; 
            background: var(--hover-bg); padding: 6px 12px; border-radius: 30px; border: 1px solid var(--border-color); user-select: none;
        }
        .switch { position: relative; display: inline-block; width: 42px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; 
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* SLIDERS */
        .slider-group { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        .label-icon { display: flex; align-items: center; gap: 8px; }
        .label-icon i { color: var(--primary-green); width: 16px; text-align: center; }
        .slider-desc { font-size: 10px; color: var(--text-muted); margin-top: 4px; line-height: 1.3; margin-left: 24px; }
        .range-input { width: 100%; height: 6px; border-radius: 5px; background: var(--border-color); outline: none; -webkit-appearance: none; }
        .range-input::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary-green); cursor: pointer; }

        /* BUTTONS */
        .btn-preset {
            background: var(--card-bg); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; font-size: 11px;
            cursor: pointer; transition: 0.2s; color: var(--text-muted); font-weight: 600; width: 100%; text-align: center;
        }
        .btn-preset:hover { border-color: var(--primary-green); color: var(--primary-green); }
        .btn-preset.active { background: var(--primary-green); color: white; border-color: var(--primary-green); }
        .btn-preset.active .preset-desc { color: #d1fae5; }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .preset-desc { font-size: 9px; color: var(--text-muted); font-weight: 400; display: block; margin-top: 2px; }

        /* TABLE */
        .table-container { max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: var(--table-head-bg); color: var(--text-muted); position: sticky; top: 0; z-index: 5; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); cursor: pointer; }
        tr:hover { background: var(--hover-bg); }

        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .bg-green { background: rgba(16, 185, 129, 0.2); color: var(--primary-green); }
        .bg-red { background: rgba(239, 68, 68, 0.2); color: var(--danger-red); }
        .popup-table { width: 100%; text-align: left; margin-top: 10px; font-size: 13px; border-collapse: collapse; }
        .popup-table td { padding: 8px 5px; border-bottom: 1px solid #eee; }

        [data-theme="dark"] .card-title { color: var(--primary-green); }
        div:where(.swal2-container) div:where(.swal2-popup) { background: var(--card-bg); color: var(--text-main); }

        .chart-wrapper { position: relative; height: 220px; width: 100%; }

    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
<div id="login-overlay" style="position: fixed; top:0; left:0; width:100%; height:100%; background:#064e3b; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <div style="background:white; padding:30px; border-radius:16px; text-align:center; width:300px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
        <h2 style="color:#064e3b; margin:0 0 20px 0;">ðŸ”’ Restricted Access</h2>
        <input type="password" id="pass-input" placeholder="Enter Passcode" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px; outline:none;">
        <button onclick="checkPass()" style="width:100%; background:#10b981; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold;">Open Dashboard</button>
        <p id="err-msg" style="color:red; font-size:12px; margin-top:10px; display:none;">Passcode Salah!</p>
    </div>
</div>

<!-- WRAPPER UTAMA (Sembunyikan konten asli dulu) -->
<div id="app-content" style="display:none; height: 100%; width: 100%;">
    <!-- ... Disini mulai masuk kode Sidebar dan Main Content Anda yang asli ... -->

    <!-- ID Sidebar tetap sama -->
    <div class="sidebar" id="sidebar">
        <div class="logo"><span>â¦¿</span> FRL Analysis</div>
        <div class="nav-item active" onclick="scrollToId('section-alloc')"><i class="fas fa-chart-pie"></i> <span data-i18n="nav_alloc">Alokasi FRL</span></div>
        <div class="nav-item" onclick="scrollToId('section-table')"><i class="fas fa-table"></i> <span data-i18n="nav_data">Data Provinsi</span></div>
        <div class="nav-item" onclick="scrollToId('section-project')"><i class="fas fa-balance-scale"></i> <span data-i18n="nav_reconcile">Rekonsiliasi</span></div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <!-- Tombol Toggle ada di sini, di dalam Header -->
                <div class="toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
                <div>
                    <h1 style="margin:0; font-size:22px; font-weight:700; color:var(--text-main);" data-i18n="page_title">Dashboard Alokasi</h1>
                    <span style="font-size:12px; color:var(--text-muted);" data-i18n="page_subtitle">Simulasi Baseline & Rekonsiliasi Proyek</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="icon-btn" onclick="toggleLanguage()" id="lang-btn">ID</div>
                <div class="icon-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></div>
                <button class="btn-download" onclick="downloadExcel()">
                    <i class="fas fa-file-excel"></i> <span data-i18n="btn_download">Excel</span>
                </button>
            </div>
        </div>

        <div class="grid-container">
            <!-- Left Panel -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <!-- KPI -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="card" style="padding: 15px;">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;" data-i18n="kpi_top">Top Provinsi</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary-green);" id="kpi-top">-</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;" data-i18n="kpi_gap">Total Gap (Defisit)</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--danger-red);" id="kpi-deficit">0</div>
                    </div>
                    <div class="card" style="padding: 15px;">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;" data-i18n="kpi_rem">Sisa FRL Non-Kunci</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--text-main);" id="kpi-rem">192.9 M</div>
                    </div>
                </div>

                <!-- Chart Top 10 -->
                <div class="card" id="section-alloc">
                    <div class="card-title"><span data-i18n="chart_alloc_title">Distribusi Alokasi (Top 10)</span></div>
                    <div class="chart-wrapper"><canvas id="chartAlloc"></canvas></div>
                </div>

                <!-- Table All -->
                <div class="card" id="section-table">
                    <div class="card-title">
                        <span data-i18n="table_all_title">Data Semua Provinsi</span>
                        <span style="font-size:11px; font-weight:400; color:var(--text-muted);" data-i18n="table_hint">Klik baris untuk detail</span>
                    </div>
                    <div class="table-container">
                        <table id="tableAll">
                            <thead><tr><th>#</th><th data-i18n="th_prov">Provinsi</th><th data-i18n="th_score">Skor</th><th data-i18n="th_alloc">Alokasi (tCO2e)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Project Section -->
                <div class="card" id="section-project">
                    <div class="card-title">
                        <div><span data-i18n="proj_title">Sisa Baseline</span> <span style="font-size:11px; color:var(--text-muted); font-weight:400" data-i18n="proj_subtitle">(Area Proyek)</span></div>
                        <div class="switch-container">
                            <span id="lbl-verra" style="color: var(--text-muted);" data-i18n="switch_proposed">Usulan</span>
                            <label class="switch"><input type="checkbox" id="checkBaselineType" onchange="toggleBaselineType()"><span class="slider"></span></label>
                            <span id="lbl-prop" style="color: var(--text-main); font-weight: 600;" data-i18n="switch_verra">Verra (Aktual)</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="height: 180px;"><canvas id="chartComp"></canvas></div>
                        <div style="height: 180px;"><canvas id="chartGap"></canvas></div>
                    </div>
                    <div class="table-container">
                        <table id="tableProject">
                            <thead><tr><th data-i18n="th_prov">Provinsi</th><th data-i18n="th_frl">Alokasi FRL</th><th data-i18n="th_base">Baseline Proyek</th><th data-i18n="th_rem">Sisa Kuota</th><th data-i18n="th_status">Status</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="control-panel">
                <div class="switch-box">
                    <div><div style="font-size:13px; font-weight:600; color:var(--dark-green);" data-i18n="hybrid_mode">Mode Hibrida</div><div style="font-size:10px; color:var(--primary-green);" data-i18n="hybrid_desc">Kunci Baseline Kaltim & Jambi</div></div>
                    <label class="switch"><input type="checkbox" id="checkHybrid" onchange="toggleHybrid()"><span class="slider"></span></label>
                </div>

                <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:var(--text-main);" data-i18n="weight_title">Bobot Indikator</div>
                
                <div class="slider-group">
                    <div class="slider-label"><div class="label-icon"><i class="fas fa-history"></i><span data-i18n="lbl_hist">Kontribusi Historis</span></div><span id="lbl-hist-val">33%</span></div>
                    <input type="range" id="sl-hist" class="range-input" min="0" max="100" value="33" oninput="balanceSliders('hist')">
                    <div class="slider-desc" data-i18n="desc_hist">Berdasarkan rata-rata emisi deforestasi masa lalu.</div>
                </div>
                
                <div class="slider-group">
                    <div class="slider-label"><div class="label-icon"><i class="fas fa-fire"></i><span data-i18n="lbl_press">Tekanan</span></div><span id="lbl-press-val">33%</span></div>
                    <input type="range" id="sl-press" class="range-input" min="0" max="100" value="33" oninput="balanceSliders('press')">
                    <div class="slider-desc" data-i18n="desc_press">Risiko kehilangan hutan saat ini.</div>
                </div>
                
                <div class="slider-group">
                    <div class="slider-label"><div class="label-icon"><i class="fas fa-tree"></i><span data-i18n="lbl_asset">Aset Karbon</span></div><span id="lbl-asset-val">34%</span></div>
                    <input type="range" id="sl-asset" class="range-input" min="0" max="100" value="34" oninput="balanceSliders('asset')">
                    <div class="slider-desc" data-i18n="desc_asset">Insentif untuk luasan tutupan hutan.</div>
                </div>

                <div style="margin-top:25px; padding-top:15px; border-top:1px solid var(--border-color);">
                    <div style="font-size:11px; font-weight:600; color:var(--text-muted); margin-bottom:10px;" data-i18n="preset_title">PRESET SKENARIO</div>
                    <div class="preset-grid">
                        <button class="btn-preset active" id="btn-p1" onclick="applyPreset(1)"><span data-i18n="p1_name">1. Netral</span><span class="preset-desc" data-i18n="p1_desc">Jalan Tengah</span></button>
                        <button class="btn-preset" id="btn-p2" onclick="applyPreset(2)"><span data-i18n="p2_name">2. Konservasi</span><span class="preset-desc" data-i18n="p2_desc">Prioritas Hutan</span></button>
                        <button class="btn-preset" id="btn-p3" onclick="applyPreset(3)"><span data-i18n="p3_name">3. Urgensi</span><span class="preset-desc" data-i18n="p3_desc">Prioritas Rate</span></button>
                        <button class="btn-preset" id="btn-p4" onclick="applyPreset(4)"><span data-i18n="p4_name">4. Mitigasi</span><span class="preset-desc" data-i18n="p4_desc">Prioritas Emiter</span></button>
                        <button class="btn-preset" id="btn-p5" onclick="applyPreset(5)"><span data-i18n="p5_name">5. Historis</span><span class="preset-desc" data-i18n="p5_desc">100% Masa Lalu</span></button>
                        <button class="btn-preset" id="btn-p6" onclick="applyPreset(6)"><span data-i18n="p6_name">6. Seimbang</span><span class="preset-desc" data-i18n="p6_desc">50% Hist, 50% Aset</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- JS TETAP SAMA, HANYA FUNGSI TOGGLE DIBAWAH INI YANG DIUBAH ---

    // TRANSLATION & DATA CONSTANTS (Paste from previous response here)
    // ... (Copy content of script from previous response) ...
    
    // START OF SCRIPT CONTENT
    
    const translations = {
        id: {
            nav_alloc: "Alokasi FRL", nav_data: "Data Provinsi", nav_reconcile: "Rekonsiliasi",
            page_title: "Dashboard Alokasi", page_subtitle: "Simulasi Baseline & Rekonsiliasi Proyek",
            btn_download: "Unduh Excel", kpi_top: "Top Provinsi", kpi_gap: "Total Gap (Defisit)", kpi_rem: "Sisa FRL Non-Kunci",
            chart_alloc_title: "Distribusi Alokasi (Top 10)",
            table_all_title: "Data Semua Provinsi", table_hint: "Klik baris untuk detail",
            th_prov: "Provinsi", th_score: "Skor", th_alloc: "Alokasi (tCO2e)",
            th_frl: "Alokasi FRL", th_base: "Baseline Proyek", th_rem: "Sisa Kuota", th_status: "Status",
            proj_title: "Sisa Baseline", proj_subtitle: "(Area Proyek)",
            switch_proposed: "Usulan", switch_verra: "Verra (Aktual)",
            hybrid_mode: "Mode Hibrida", hybrid_desc: "Kunci Baseline Kaltim & Jambi",
            weight_title: "Bobot Indikator",
            lbl_hist: "Historis", desc_hist: "Berdasarkan rata-rata emisi masa lalu.",
            lbl_press: "Tekanan", desc_press: "Risiko kehilangan hutan saat ini.",
            lbl_asset: "Aset Karbon", desc_asset: "Insentif luasan hutan tersisa.",
            preset_title: "PRESET SKENARIO",
            p1_name: "1. Netral", p1_desc: "Jalan Tengah",
            p2_name: "2. Konservasi", p2_desc: "Prioritas Hutan",
            p3_name: "3. Urgensi", p3_desc: "Prioritas Rate",
            p4_name: "4. Mitigasi", p4_desc: "Prioritas Emiter",
            p5_name: "5. Historis", p5_desc: "100% Masa Lalu",
            p6_name: "6. Seimbang", p6_desc: "50% Hist, 50% Aset",
            popup_title: "Analisis Sisa Baseline", popup_no_proj: "Tidak ada proyek terdaftar.",
            status_deficit: "DEFISIT", status_surplus: "SURPLUS"
        },
        en: {
            nav_alloc: "FRL Allocation", nav_data: "Provincial Data", nav_reconcile: "Reconciliation",
            page_title: "Allocation Dashboard", page_subtitle: "Baseline Simulation & Project Reconciliation",
            btn_download: "Download Excel", kpi_top: "Top Province", kpi_gap: "Total Gap (Deficit)", kpi_rem: "Remaining Non-Locked FRL",
            chart_alloc_title: "Allocation Distribution (Top 10)",
            table_all_title: "All Provincial Data", table_hint: "Click row for details",
            th_prov: "Province", th_score: "Score", th_alloc: "Allocation (tCO2e)",
            th_frl: "FRL Alloc", th_base: "Project Baseline", th_rem: "Remaining", th_status: "Status",
            proj_title: "Remaining Baseline", proj_subtitle: "(Project Areas)",
            switch_proposed: "Proposed", switch_verra: "Verra (Actual)",
            hybrid_mode: "Hybrid Mode", hybrid_desc: "Lock Kaltim & Jambi Baseline",
            weight_title: "Indicator Weights",
            lbl_hist: "Historical", desc_hist: "Based on historical emission average.",
            lbl_press: "Pressure", desc_press: "Current forest loss risk.",
            lbl_asset: "Carbon Asset", desc_asset: "Incentive for remaining forest cover.",
            preset_title: "SCENARIO PRESETS",
            p1_name: "1. Neutral", p1_desc: "Balanced Approach",
            p2_name: "2. Conservation", p2_desc: "HFLD Priority",
            p3_name: "3. Urgency", p3_desc: "Rate Priority",
            p4_name: "4. Mitigation", p4_desc: "Emitter Priority",
            p5_name: "5. Historical", p5_desc: "100% Past Data",
            p6_name: "6. Balanced", p6_desc: "50% Hist, 50% Asset",
            popup_title: "Remaining Baseline Analysis", popup_no_proj: "No registered projects.",
            status_deficit: "DEFICIT", status_surplus: "SURPLUS"
        }
    };

    // CONSTANTS & DATA
    const FRL_NATIONAL = 192921295;
    const LOCK_KALTIM = 68342613; const LOCK_JAMBI = 26764488;
    const provinces = [
        { name: "Aceh", h: 0.25, p: 0.54, a: 0.36 }, { name: "Bali", h: 0.02, p: 0.58, a: 0.02 }, { name: "Banten", h: 0.04, p: 0.72, a: 0.03 },
        { name: "Bengkulu", h: 0.11, p: 0.71, a: 0.10 }, { name: "DI Yogyakarta", h: 0.00, p: 0.29, a: 0.01 }, { name: "DKI Jakarta", h: 0.00, p: 0.25, a: 0.00 },
        { name: "Gorontalo", h: 0.04, p: 0.51, a: 0.07 }, { name: "Jambi", h: 0.34, p: 0.85, a: 0.19 }, { name: "Jawa Barat", h: 0.10, p: 0.57, a: 0.14 },
        { name: "Jawa Tengah", h: 0.06, p: 0.43, a: 0.12 }, { name: "Jawa Timur", h: 0.09, p: 0.55, a: 0.13 }, { name: "Kalimantan Barat", h: 0.97, p: 0.75, a: 0.72 },
        { name: "Kalimantan Selatan", h: 0.21, p: 0.90, a: 0.11 }, { name: "Kalimantan Tengah", h: 1.00, p: 0.74, a: 0.73 }, { name: "Kalimantan Timur", h: 0.70, p: 0.70, a: 0.67 },
        { name: "Kalimantan Utara", h: 0.22, p: 0.35, a: 0.60 }, { name: "Kep. Bangka Belitung", h: 0.12, p: 0.95, a: 0.05 }, { name: "Kep. Riau", h: 0.06, p: 0.97, a: 0.02 },
        { name: "Lampung", h: 0.12, p: 0.83, a: 0.08 }, { name: "Maluku", h: 0.18, p: 0.52, a: 0.30 }, { name: "Maluku Utara", h: 0.15, p: 0.63, a: 0.17 },
        { name: "Nusa Tenggara Barat", h: 0.04, p: 0.39, a: 0.09 }, { name: "Nusa Tenggara Timur", h: 0.12, p: 0.59, a: 0.16 }, { name: "Papua", h: 0.19, p: 0.27, a: 0.77 },
        { name: "Papua Barat", h: 0.16, p: 0.30, a: 0.53 }, { name: "Papua Barat Daya", h: 0.10, p: 0.29, a: 0.36 }, { name: "Papua Pegunungan", h: 0.15, p: 0.31, a: 0.50 },
        { name: "Papua Selatan", h: 0.30, p: 0.30, a: 1.00 }, { name: "Papua Tengah", h: 0.12, p: 0.23, a: 0.60 }, { name: "Riau", h: 0.77, p: 0.94, a: 0.25 },
        { name: "Sulawesi Barat", h: 0.07, p: 0.58, a: 0.10 }, { name: "Sulawesi Selatan", h: 0.16, p: 0.62, a: 0.19 }, { name: "Sulawesi Tengah", h: 0.29, p: 0.60, a: 0.37 },
        { name: "Sulawesi Tenggara", h: 0.15, p: 0.59, a: 0.20 }, { name: "Sulawesi Utara", h: 0.08, p: 0.73, a: 0.07 }, { name: "Sumatera Barat", h: 0.21, p: 0.65, a: 0.23 },
        { name: "Sumatera Selatan", h: 0.69, p: 1.00, a: 0.22 }, { name: "Sumatera Utara", h: 0.40, p: 0.80, a: 0.27 }
    ];
    const projectData = {
        "Aceh": { verra: 256964, proposed: 25000 }, "Jawa Barat": { verra: 2478, proposed: 250 },
        "Kalimantan Barat": { verra: 13603100, proposed: 1500000 }, "Kalimantan Tengah": { verra: 34192283, proposed: 3500000 },
        "Kalimantan Utara": { verra: 2351492, proposed: 200000 }, "Maluku": { verra: 2017349, proposed: 150000 },
        "Riau": { verra: 9826564, proposed: 1000000 }, "Sulawesi Selatan": { verra: 1045496, proposed: 100000 },
        "Sumatera Selatan": { verra: 2677138, proposed: 250000 }
    };

    let currentLang = localStorage.getItem('frl_lang') || 'id';
    let currentTheme = localStorage.getItem('frl_theme') || 'light';
    let isHybrid = false, useVerra = false;
    let chartAlloc, chartComp, chartGap;

    // --- CORE FUNCTIONS ---
    
    function toggleSidebar() {
        // Ubah class untuk sidebar
        document.getElementById('sidebar').classList.toggle('closed');
        // Ubah class untuk body agar grid layout menyesuaikan
        document.body.classList.toggle('sidebar-hidden');
        
        // Trigger resize agar ChartJS menyesuaikan lebar baru
        setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
    }

    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(currentTheme);
    }

    function setTheme(theme) {
        const icon = document.getElementById('theme-icon');
        if (theme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
        } else {
            document.body.removeAttribute('data-theme');
            icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
        }
        localStorage.setItem('frl_theme', theme);
        updateChartColors();
    }

    function toggleLanguage() {
        currentLang = currentLang === 'id' ? 'en' : 'id';
        setLanguage(currentLang);
    }

    function setLanguage(lang) {
        document.getElementById('lang-btn').innerText = lang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[lang][key]) el.innerText = translations[lang][key];
        });
        localStorage.setItem('frl_lang', lang);
        updateDashboard(); 
    }

    function t(key) { return translations[currentLang][key] || key; }

    function calculate() {
        const wH = parseInt(document.getElementById('sl-hist').value);
        const wP = parseInt(document.getElementById('sl-press').value);
        const wA = parseInt(document.getElementById('sl-asset').value);
        document.getElementById('lbl-hist-val').innerText = wH + "%";
        document.getElementById('lbl-press-val').innerText = wP + "%";
        document.getElementById('lbl-asset-val').innerText = wA + "%";

        let totalScore = 0, totalScoreOthers = 0;
        provinces.forEach(pr => {
            pr.score = (pr.h * wH) + (pr.p * wP) + (pr.a * wA);
            totalScore += pr.score;
            if(pr.name !== "Kalimantan Timur" && pr.name !== "Jambi") totalScoreOthers += pr.score;
        });

        return provinces.map(pr => {
            let alloc = 0;
            if(isHybrid) {
                if(pr.name === "Kalimantan Timur") alloc = LOCK_KALTIM;
                else if(pr.name === "Jambi") alloc = LOCK_JAMBI;
                else alloc = (pr.score / totalScoreOthers) * (FRL_NATIONAL - LOCK_KALTIM - LOCK_JAMBI);
            } else {
                alloc = (pr.score / totalScore) * FRL_NATIONAL;
            }
            return { ...pr, alloc };
        }).sort((a,b) => b.alloc - a.alloc);
    }

    function updateDashboard() {
        const data = calculate();
        document.getElementById('kpi-top').innerText = data[0].name;
        updateChartAlloc(data.slice(0, 10));
        const tAll = document.querySelector('#tableAll tbody');
        tAll.innerHTML = '';
        data.forEach((d, i) => {
            tAll.innerHTML += `<tr onclick="showDetail('${d.name}')"><td>${i+1}</td><td style="font-weight:500">${d.name}</td><td>${d.score.toFixed(1)}</td><td>${Math.round(d.alloc).toLocaleString('id-ID')}</td></tr>`;
        });
        updateProjectSection(data);
    }

    function updateProjectSection(data) {
        const pNames = Object.keys(projectData);
        const pData = data.filter(d => pNames.includes(d.name));
        let totDef = 0;
        const labels=[], allocs=[], bases=[], gaps=[], colors=[];
        const tBody = document.querySelector('#tableProject tbody');
        tBody.innerHTML = '';

        pData.forEach(d => {
            const base = useVerra ? projectData[d.name].verra : projectData[d.name].proposed;
            const gap = d.alloc - base;
            if(gap < 0) totDef += Math.abs(gap);
            labels.push(d.name); allocs.push(d.alloc); bases.push(base); gaps.push(gap);
            colors.push(gap < 0 ? '#ef4444' : '#10b981');
            tBody.innerHTML += `<tr onclick="showDetail('${d.name}')"><td>${d.name}</td><td>${Math.round(d.alloc).toLocaleString('id-ID')}</td><td>${base.toLocaleString('id-ID')}</td><td style="font-weight:700; color:${gap<0?'#ef4444':'#10b981'}">${gap>0?'+':''}${Math.round(gap).toLocaleString('id-ID')}</td><td><span class="status-badge ${gap<0?'bg-red':'bg-green'}">${gap<0?t('status_deficit'):t('status_surplus')}</span></td></tr>`;
        });
        document.getElementById('kpi-deficit').innerText = (totDef/1000000).toFixed(1) + " M";
        updateChartComp(labels, allocs, bases); updateChartGap(labels, gaps, colors);
    }

    // --- CHART HELPERS & UPDATES ---
    function getTextColor() { return currentTheme === 'dark' ? '#94a3b8' : '#64748b'; }
    function updateChartColors() {
        const color = getTextColor();
        [chartAlloc, chartComp, chartGap].forEach(c => { if(c) { c.options.scales.x.ticks.color = color; c.update(); } });
    }

    function updateChartAlloc(data) {
        const lbl = data.map(d => d.name), val = data.map(d => d.alloc);
        const bg = isHybrid ? data.map(d=>(d.name=="Kalimantan Timur"||d.name=="Jambi")?'#f59e0b':'#10b981') : '#10b981';
        if(chartAlloc) { chartAlloc.data.labels=lbl; chartAlloc.data.datasets[0].data=val; chartAlloc.data.datasets[0].backgroundColor=bg; chartAlloc.data.datasets[0].label=t('th_alloc'); chartAlloc.update(); }
        else {
            chartAlloc = new Chart(document.getElementById('chartAlloc'), { type: 'bar', data: { labels: lbl, datasets: [{data: val, backgroundColor: bg, borderRadius: 4, label: t('th_alloc')}] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales:{x:{ticks:{color:getTextColor(), font:{size:9}}}, y:{ticks:{display:false}}} } });
        }
    }
    function updateChartComp(lbl, alloc, base) {
        if(chartComp) { chartComp.data.labels=lbl; chartComp.data.datasets[0].data=alloc; chartComp.data.datasets[0].label=t('th_frl'); chartComp.data.datasets[1].data=base; chartComp.data.datasets[1].label=t('th_base'); chartComp.update(); }
        else { chartComp = new Chart(document.getElementById('chartComp'), { type: 'bar', data: { labels: lbl, datasets: [{label:t('th_frl'), data:alloc, backgroundColor:'#10b981'}, {label:t('th_base'), data:base, backgroundColor:'#94a3b8'}] }, options: { responsive: true, maintainAspectRatio: false, scales:{x:{ticks:{color:getTextColor(), font:{size:9}}}} } }); }
    }
    function updateChartGap(lbl, g, bg) {
        if(chartGap) { chartGap.data.labels=lbl; chartGap.data.datasets[0].data=g; chartGap.data.datasets[0].backgroundColor=bg; chartGap.data.datasets[0].label='Gap'; chartGap.update(); }
        else { chartGap = new Chart(document.getElementById('chartGap'), { type: 'bar', data: { labels: lbl, datasets: [{label:'Gap', data:g, backgroundColor:bg}] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:getTextColor(), font:{size:9}}}} } }); }
    }

    // --- OTHER ACTIONS ---
    function downloadExcel() {
        const data = calculate();
        const exportData = data.map(d => {
            let row = {}; row[t('th_prov')] = d.name; row[t('th_score')] = d.score.toFixed(4); row[t('th_alloc')] = d.alloc;
            if (projectData[d.name]) {
                const base = useVerra ? projectData[d.name].verra : projectData[d.name].proposed;
                row[t('th_base')] = base; row[t('th_rem')] = d.alloc - base; row[t('th_status')] = (d.alloc - base) < 0 ? "DEFISIT" : "SURPLUS";
            }
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "FRL_Allocation"); XLSX.writeFile(wb, "FRL_Analysis.xlsx");
    }

    function toggleBaselineType() { useVerra = document.getElementById('checkBaselineType').checked; setSwitchLabel(); updateDashboard(); }
    function setSwitchLabel() {
        const lblV = document.getElementById('lbl-prop'), lblP = document.getElementById('lbl-verra');
        const active = currentTheme === 'dark' ? '#fff' : '#0f172a'; const muted = currentTheme === 'dark' ? '#64748b' : '#94a3b8';
        if(useVerra) { lblV.style.color=active; lblV.style.fontWeight="600"; lblP.style.color=muted; lblP.style.fontWeight="400"; }
        else { lblP.style.color=active; lblP.style.fontWeight="600"; lblV.style.color=muted; lblV.style.fontWeight="400"; }
    }
    function toggleHybrid() { isHybrid = document.getElementById('checkHybrid').checked; updateDashboard(); }
    
    function balanceSliders(type) {
        let h=parseInt(document.getElementById('sl-hist').value), p=parseInt(document.getElementById('sl-press').value), a=parseInt(document.getElementById('sl-asset').value);
        if(type==='hist'){ let r=100-h; if(p+a===0){p=r/2;a=r/2}else{let x=p/(p+a);p=r*x;a=r*(1-x)} }
        else if(type==='press'){ let r=100-p; if(h+a===0){h=r/2;a=r/2}else{let x=h/(h+a);h=r*x;a=r*(1-x)} }
        else{ let r=100-a; if(h+p===0){h=r/2;p=r/2}else{let x=h/(h+p);h=r*x;p=r*(1-x)} }
        document.getElementById('sl-hist').value=Math.round(h); document.getElementById('sl-press').value=Math.round(p); document.getElementById('sl-asset').value=100-Math.round(h)-Math.round(p);
        document.querySelectorAll('.btn-preset').forEach(b=>b.classList.remove('active')); updateDashboard();
    }

    function applyPreset(id) {
        let h, p, a;
        switch(id) { case 1: h=33;p=33;a=34; break; case 2: h=20;p=20;a=60; break; case 3: h=30;p=50;a=20; break; case 4: h=60;p=20;a=20; break; case 5: h=100;p=0;a=0; break; case 6: h=50;p=0;a=50; break; }
        document.getElementById('sl-hist').value=h; document.getElementById('sl-press').value=p; document.getElementById('sl-asset').value=a;
        document.querySelectorAll('.btn-preset').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-p${id}`).classList.add('active'); updateDashboard();
    }

    function showDetail(provName) {
        const d = calculate().find(p => p.name === provName);
        const hasProject = projectData[provName] ? true : false;
        let projectInfo = `<div style="background:var(--hover-bg); padding:10px; border-radius:8px; color:var(--text-muted); font-style:italic; font-size:12px;">${t('popup_no_proj')}</div>`;
        if (hasProject) {
            const v = projectData[provName].verra, p = projectData[provName].proposed;
            const gapV = d.alloc - v, gapP = d.alloc - p;
            projectInfo = `<table class="popup-table" style="color:var(--text-main);"><tr><td colspan="3" style="font-weight:600; padding-bottom:5px; border-bottom:2px solid var(--border-color); color:var(--primary-green);">${t('popup_title')}</td></tr><tr style="font-size:11px; color:var(--text-muted); font-weight:600;"><td>Skenario</td><td align="right">Baseline</td><td align="right">${t('th_rem')}</td></tr><tr><td>Verra</td><td align="right">${v.toLocaleString('id-ID')}</td><td align="right" style="font-weight:bold; color:${gapV<0?'#ef4444':'#10b981'}">${gapV.toLocaleString('id-ID')}</td></tr><tr><td>Proposed</td><td align="right">${p.toLocaleString('id-ID')}</td><td align="right" style="font-weight:bold; color:${gapP<0?'#ef4444':'#10b981'}">${gapP.toLocaleString('id-ID')}</td></tr></table>`;
        }
        Swal.fire({ background: getComputedStyle(document.body).getPropertyValue('--card-bg'), color: getComputedStyle(document.body).getPropertyValue('--text-main'), html: `<div style="text-align:left; font-family:'Poppins',sans-serif;"><h2 style="margin:0 0 15px 0; font-size:20px; color:var(--text-main); border-bottom:1px solid var(--border-color); padding-bottom:10px;">${d.name}</h2><div style="margin-bottom:20px; background:rgba(16, 185, 129, 0.1); padding:15px; border-radius:12px; border:1px solid var(--primary-green);"><div style="font-size:12px; color:var(--primary-green); font-weight:600; text-transform:uppercase; margin-bottom:5px;">${t('th_frl')}</div><div style="font-size:26px; font-weight:700; color:var(--primary-green);">${Math.round(d.alloc).toLocaleString('id-ID')} <span style="font-size:14px;">tCO2e</span></div></div>${projectInfo}</div>`, showConfirmButton: false, showCloseButton: true });
    }

    function scrollToId(id) { document.getElementById(id).scrollIntoView({behavior:'smooth'}); }
    window.onload = () => { setLanguage(currentLang); setTheme(currentTheme); applyPreset(1); };

</script>
</div>
    <script>
    // Konfigurasi Password
    const PASSCODE = "FRL2025"; // Ganti password sesuai keinginan Anda

    function checkPass() {
        const input = document.getElementById('pass-input').value;
        if(input === PASSCODE) {
            document.getElementById('login-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex'; // Tampilkan konten
                // Trigger resize biar grafik muncul sempurna
                window.dispatchEvent(new Event('resize'));
            }, 500);
            // Simpan sesi agar tidak perlu login lagi saat refresh (Opsional)
            sessionStorage.setItem('frl_auth', 'true');
        } else {
            document.getElementById('err-msg').style.display = 'block';
        }
    }

    // Cek apakah user sudah login sebelumnya
    if(sessionStorage.getItem('frl_auth') === 'true') {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
    }
    
    // Support Enter Key
    document.getElementById("pass-input").addEventListener("keypress", function(event) {
      if (event.key === "Enter") { checkPass(); }
    });
</script>
    <script>
    // Mencegah Klik Kanan
    document.addEventListener('contextmenu', event => event.preventDefault());

    // Mencegah Tombol F12, Ctrl+Shift+I, Ctrl+U (View Source)
    document.onkeydown = function(e) {
        if(event.keyCode == 123) { // F12
            return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
            return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
            return false;
        }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U
            return false;
        }
    }
</script>
</body>
</html>
